# 事件/对话同步 v1 - Why

## 背景
`networkplugin/Patch/Network/EventSyncPatch.cs` 通过 Harmony 钩子拦截跑图过程中的 Adventure 事件与 VN 对话选择，并把关键决策同步到多人联机的其他客户端。

当前实现已具备发送/接收的消息类型：
- `OnEventStart`
- `OnEventSelection`
- `OnDialogText`
- `OnDialogOptions`
- `OnEventVoteCast`
- `OnEventVotingResult`

但其中存在多处“仅诊断/断线重连占位”的处理逻辑，尚不能为断线重连/中途加入提供确定性的追赶（catch-up）。

## 问题
多人联机下，事件/对话必须保持所有客户端的进度一致，不能出现分叉。
现状：
- 仅 Host 允许确认选择（权威推进是对的），但
- 非 Host 在断线重连/中途加入时缺少可靠的追赶手段。
- 部分消息在接收端仅记录日志/直接忽略；部分本地落地依赖时序（协程/私有字段），脆弱。

## 目标
1. 确定性推进：所有客户端最终进入同一事件分支。
2. 防回环：远端落地触发的本地 UI/逻辑不应再次广播造成“回声”。
3. 复用现有 `networkplugin/Network` 基础设施（消息类型、客户端事件总线、服务器转发），避免冗余。
4. 在不引入新子系统的前提下，为重连/中途加入扩展“最小可用追赶能力”。

补充边界（按需求定义）：
- “中途加入”指玩家在地图上加入后，应回到其上次退出时的地图节点；进入节点对应关卡及关卡内同步由其他代码负责，本方案不展开。
- 事件触发允许来自非 Host，但最终分支选择与推进仍由 Host 仲裁并广播。

## 非目标（v1）
- 完整序列化每个事件的全部内部状态。
- 保证可回放任意 Yarn 节点的所有副作用。
- 重写网络协议/整体联机架构。
- 处理“进入关卡/关卡内战斗同步”的逻辑（由其他模块负责）。

## 验收标准
- Host 做出对话/事件选择后，所有客户端都能推进到相同分支。
- 当某个 `eventId` 启用投票模式时，所有客户端本地都不能直接推进，只能在 Host 结算并广播最终选择后统一推进。
- 客户端在“对话选项阶段”断线后重连，能够恢复足够上下文继续运行（至少包含：当前 `eventId` + 最新选项 + 最终选择/待落地选择）。

一致性要求（权威模型 B）：
- 非 Host 触发事件时，允许发起“事件开始/请求”，但不允许本地确认导致分叉；最终仍以 Host 广播的 `OnEventSelection` 为准。

## 风险
- UI/Harmony 钩子对时序敏感（协程/私有字段）。
- Yarn 对话阶段可能多次请求本地化文本，需要去重。
- 追赶/回放可能需要新增或复用快照消息（应优先复用 MidGameJoin 能力）。
