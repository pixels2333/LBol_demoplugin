# why

## 背景
当前补丁文件里有一个 TODO：需要把“来自主机的同步数据”真正应用到本地游戏。

但你已经明确了：
这次要解决的不是“把所有人强行拉回同一条进度/同一个节点”，而是解决 **房间/战斗残局同步**。

用通俗的话说：
- 大家可以各走各的节点。
- 如果客机进入了主机没走过的节点：就用已经同步过、和主机一致的随机种子来本地生成怪物/内容。
- 关键是“同一个房间/同一场战斗”：谁先进去，就把这个房间里怪物的真实状态（血量/格挡/护盾/状态/意图等）上传给主机；主机再同步给其他人。
- 其他人后来进入这个房间：要能直接看到并应用残局；如果战斗已经结束，就应该直接领取奖励（不再重打一遍）。

## 需求（你刚刚拍板的规则）
1) 主机不主动“推全局存档同步”来统一路线；大家可以分线探索。
2) 房间/战斗以“先进入的人”为权威来源：先进入的人把房间信息上传到主机，主机作为中枢转发给其他人。
3) 客机遇到“主机/他人没走过”的节点：按同步过的随机种子在本地生成。
4) 存档槽位编号从 1 开始算（如仍保留存档相关请求）。
5) 需要同时覆盖直连与 Relay。

## 问题与根因（为什么需要做这一套）
1) 没有“房间状态中枢”，其他人进入同一房间时只能重新生成/重新开战
- 结果就是：同一房间在不同玩家那里出现不同的怪物、不同的血量，甚至出现“别人已经打完了你还要再打一遍”。

2) 仅同步随机种子不够
- 随机种子只能保证“没走过的房间怎么生成”。
- 一旦房间已经开战/战斗进行中/战斗结束，关键就变成“残局状态与奖励结果”，这必须靠房间快照同步。

3) 需要一个稳定的“房间标识”（RoomKey）
- 主机要能知道你说的是哪个房间；其他人也要能用同一个标识去查询/应用。
- RoomKey 怎么取（地图节点坐标/索引/路径/层数等），必须在实现阶段从原游戏代码（lbol/）里找一个稳定、可复现的口径。

4) 网络路由必须可靠
- 新的房间同步消息需要在直连与 Relay 都能正确到达“主机中枢”和目标客户端，否则同步会丢。

## 目标（成功标准）
- 任意玩家进入某房间并触发战斗：
  - 生成阶段：把该房间的怪物列表（种类/数量）与初始状态上传到主机。
  - 战斗阶段：把怪物的血量/格挡/护盾/状态/意图等关键变化上传到主机（可按回合节流）。
  - 结束阶段：把“战斗已结束 + 奖励结果”上传到主机。
- 其他玩家进入同一房间：
  - 若战斗进行中：应用残局（生成对应怪物并把状态改到一致）。
  - 若战斗已结束：直接应用“已清房”状态并领取对应奖励。

## 约束与原则
- 不追求 100% 完美，但要做到：不崩溃、可诊断、同步失败可降级（例如退回到本地生成/提示不同步）。
- 事件尽量单播（请求/响应定向），避免状态风暴。
- SaveSlot 若继续沿用（存档相关）：槽位编号从 1 开始算。
